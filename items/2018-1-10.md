Back to pre-Christmas project â€”Aviancaâ€™s Xamarin.Forms app for Android & iOSâ€”
Iâ€™m assigned a bug on gettings 401s because token refreshes donâ€™t seem to work.
Our app uses Refit to build the gateways provided through intermediate NuGet
packages built from our server-side workmates.

Applying a retrial politic to refresh token, Iâ€™ve discovered the need to

1.  refresh the token, which internally creates a new `HttpClient`, and

2.  recreate the gateways, to start working with such

Some projects ago my workmates and I came up with this handy method at our
`BaseViewModel` â€”have simplified code a little bit for the sake of clearness:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Â Â Â Â protectedÂ asyncÂ Task<T>Â ExecuteInternetBoundCallAsync<T>(Func<Task<T>>Â operation,Â intÂ pendingRetriesÂ =Â DefaultPendingRetries)Â Â 
Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â varÂ isThereConnectionÂ =Â CheckInternetConnectionAndAlert();Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â ifÂ (!isThereConnection)Â Â 
Â Â Â Â Â Â Â Â {Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ default(T);Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â TÂ result;Â Â 
Â Â Â Â Â Â Â Â varÂ retryÂ =Â false;Â Â 
Â Â Â Â Â Â Â Â IsBusyÂ =Â true;Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â tryÂ Â 
Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â resultÂ =Â awaitÂ operation();Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â Â Â catchÂ (ExceptionÂ ex)Â whenÂ (exÂ isÂ Refit.ApiException)Â Â 
Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â resultÂ =Â default(T);Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â varÂ apiExceptionÂ =Â exÂ asÂ Refit.ApiException;Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (apiException.StatusCodeÂ ==Â HttpStatusCode.UnauthorizedÂ &&Â pendingRetriesÂ >Â 0)Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â retryÂ =Â true;Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â elseÂ Â 
Â Â Â Â Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HandleStatusCode(apiException.StatusCode);Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â Â Â catchÂ Â 
Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â resultÂ =Â default(T);Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â //Â AlertÂ onÂ somethingÂ wentÂ wrongÂ Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â Â Â finallyÂ Â 
Â Â Â Â Â Â Â Â {Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â IsBusyÂ =Â false;Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â ifÂ (retry)Â Â 
Â Â Â Â Â Â Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â //Â RefreshÂ tokenÂ &Â gatewaysÂ Â 
Â Â Â Â Â Â Â Â Â Â Â Â resultÂ =Â awaitÂ ExecuteInternetBoundCallAsync(operation,Â pendingRetriesÂ -Â 1);Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â returnÂ result;Â Â 
Â Â Â Â }
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Â 

C\# Exception catching fits so good here. So, from our VMs, we can do things
like:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Â Â Â Â varÂ dataÂ =Â awaitÂ ExecuteInternetBoundCallAsync<DataModel>(asyncÂ ()Â => awaitÂ dataGateway.GetAsync());

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Â 

; with the goal of making the call retry up to `DefaultPendingRetries` times.

Â 

Oh! Thereâ€™s too a new version of
[WhenTheAppWasBuilt](https://github.com/DevsDNA/WhenTheAppWasBuilt/) ðŸ˜Ž
